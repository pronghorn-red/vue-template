name: Deploy to Render (pronghorn- prefix - Robust Fix)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install & Build (validation)
        run: |
          npm ci
          npm run build

      - name: Set Render Service Name (pronghorn- + repo name)
        run: |
          REPO_NAME=$(basename ${{ github.repository }})
          SERVICE_NAME="pronghorn-$REPO_NAME"
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
          echo "RENDER_SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_ENV
          echo "Target URL: https://$SERVICE_NAME.onrender.com"

      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          set -e

          SERVICE_NAME="${{ env.RENDER_SERVICE_NAME }}"
          echo "Target service: $SERVICE_NAME"

          # Helper to get response body
          get_body() {
            local method="$1"
            local url="$2"
            local data="$3"
            curl -fsS -X "$method" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              "$url" \
              ${data:+-d "$data"}
          }

          # 1. Try create (skip if 400/409)
          echo "Attempting to create static site..."
          CREATE_JSON=$(jq -n \
            --arg name "$SERVICE_NAME" \
            --arg repo "https://github.com/${{ github.repository }}.git" \
            '{
              name: $name,
              type: "web",
              runtime: "static",
              region: "oregon",
              branch: "main",
              repo: $repo,
              buildCommand: "npm install && npm run build",
              publishPath: "dist",
              autoDeploy: true
            }')

          CREATE_BODY=$(get_body POST "https://api.render.com/v1/services" "$CREATE_JSON")
          CREATE_CODE=$(curl -fsS -w "%{http_code}" -o /dev/null -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$CREATE_JSON" "https://api.render.com/v1/services")

          if [[ "$CREATE_CODE" == "201" ]]; then
            SERVICE_ID=$(echo "$CREATE_BODY" | jq -r '.id // empty')
            echo "‚úÖ Created service ‚Üí ID: $SERVICE_ID"
          else
            echo "Create returned $CREATE_CODE (likely exists or auth issue). Debug:"
            echo "$CREATE_BODY" | jq . || echo "No body"
            echo "Proceeding to search..."
          fi

          # 2. Search for ID (paginated, no initial params)
          echo "Searching for service '$SERVICE_NAME'..."
          cursor=""
          SERVICE_ID=""
          page=0
          while [[ -z "$SERVICE_ID" || "$SERVICE_ID" == "null" ]]; do
            ((page++))
            search_url="https://api.render.com/v1/services"
            if [[ -n "$cursor" ]]; then
              search_url="$search_url?cursor=$cursor"
            fi
            echo "Page $page..."

            PAGE_BODY=$(get_body GET "$search_url")
            PAGE_CODE=$(curl -fsS -w "%{http_code}" -o /dev/null -X GET \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              "$search_url")

            if [[ "$PAGE_CODE" != "200" ]]; then
              echo "Search failed (HTTP $PAGE_CODE). Check API key & account permissions."
              echo "$PAGE_BODY" | jq . || echo "No body"
              exit 1
            fi

            SERVICE_ID=$(echo "$PAGE_BODY" | jq -r --arg n "$SERVICE_NAME" '.[]? | select(.name == $n and .runtime == "static") | .id // empty')

            if [[ -n "$SERVICE_ID" && "$SERVICE_ID" != "null" ]]; then
              echo "‚úÖ Found service ‚Üí ID: $SERVICE_ID"
              break
            fi

            cursor=$(echo "$PAGE_BODY" | jq -r '.next // empty')
            if [[ -z "$cursor" ]]; then
              echo "‚ùå Service not found after $page pages. Create manually in dashboard first."
              exit 1
            fi
          done

          # 3. Apply SPA rewrites for Vue Router
          echo "Applying SPA rewrites..."
          UPDATE_JSON=$(jq -n \
            '{
              staticSite: {
                rewriteRules: [{
                  source: "/*",
                  destination: "/index.html",
                  statusCode: 200
                }]
              }
            }')
          UPDATE_BODY=$(get_body PATCH "https://api.render.com/v1/services/$SERVICE_ID" "$UPDATE_JSON")
          echo "Rewrites applied (response: $(echo "$UPDATE_BODY" | jq -r '.message // "ok"'))"

          # 4. Trigger deploy
          echo "Triggering deploy..."
          DEPLOY_BODY=$(get_body POST "https://api.render.com/v1/services/$SERVICE_ID/deploys" "{}")
          DEPLOY_CODE=$(curl -fsS -w "%{http_code}" -o /dev/null -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{}' "https://api.render.com/v1/services/$SERVICE_ID/deploys")

          if [[ "$DEPLOY_CODE" != "201" ]]; then
            echo "Deploy trigger failed (HTTP $DEPLOY_CODE). Response: $DEPLOY_BODY"
            exit 1
          fi

          DEPLOY_ID=$(echo "$DEPLOY_BODY" | jq -r '.id // empty')
          echo "üöÄ Deploy started ‚Üí $DEPLOY_ID"
          echo "Dashboard: https://dashboard.render.com/srv/$SERVICE_ID"

          # 5. Wait for live
          echo "Waiting (max 10 min)..."
          for i in {1..40}; do
            sleep 15
            STATUS_BODY=$(get_body GET "https://api.render.com/v1/services/$SERVICE_ID/deploys/$DEPLOY_ID")
            STATUS=$(echo "$STATUS_BODY" | jq -r '.status // "unknown"')
            echo "[$i/40] $STATUS"

            if [[ "$STATUS" == "live" ]]; then
              echo "‚úÖ LIVE ‚Üí https://$SERVICE_NAME.onrender.com"
              exit 0
            fi
            if [[ "$STATUS" == "failed" || "$STATUS" == "build_failed" ]]; then
              echo "‚ùå FAILED! Logs: $STATUS_BODY"
              exit 1
            fi
          done

          echo "‚è∞ Timeout. Check dashboard."
          exit 1