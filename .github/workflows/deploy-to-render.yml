name: Deploy to Render (pronghorn- prefix - Fixed)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install & Build (validation)
        run: |
          npm ci
          npm run build

      - name: Set Render Service Name (pronghorn- + repo name)
        run: |
          REPO_NAME=$(basename ${{ github.repository }})
          SERVICE_NAME="pronghorn-$REPO_NAME"
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
          echo "RENDER_SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_ENV
          echo "Will deploy to ‚Üí https://$SERVICE_NAME.onrender.com"

      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          set -e

          SERVICE_NAME="${{ env.RENDER_SERVICE_NAME }}"
          echo "Target service: $SERVICE_NAME"

          # API helper: returns body on success, exits on 4xx/5xx, sets HTTP_CODE
          api() {
            local method="$1"
            local url="$2"
            local data="$3"
            local http_code
            http_code=$(curl -fsS --write-out "%{http_code}" -X "$method" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              "$url" \
              ${data:+-d "$data"} \
              -o >(cat) 2>/dev/null || echo "000")
            echo "$http_code"
          }

          # Body fetch helper (separate for responses)
          api_body() {
            local method="$1"
            local url="$2"
            local data="$3"
            curl -fsS -X "$method" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              "$url" \
              ${data:+-d "$data"}
          }

          # 1. Try to create the service (correct payload for static site)
          echo "Attempting to create static site '$SERVICE_NAME'..."
          CREATE_JSON=$(jq -n \
            --arg name "$SERVICE_NAME" \
            --arg repo "https://github.com/${{ github.repository }}.git" \
            '{
              name: $name,
              type: "web",
              runtime: "static",
              region: "oregon",
              branch: "main",
              repo: $repo,
              buildCommand: "npm install && npm run build",
              publishPath: "dist",
              autoDeploy: true
            }')

          HTTP_CODE=$(api POST "https://api.render.com/v1/services" "$CREATE_JSON")
          if [[ "$HTTP_CODE" == "201" ]]; then
            SERVICE_ID=$(echo "$CREATE_JSON" | jq -r '.name')  # Temp; refetch below
            echo "‚úÖ Created new service (HTTP 201)"
          elif [[ "$HTTP_CODE" == "409" ]]; then
            echo "Service exists (HTTP 409) - searching for ID..."
          elif [[ "$HTTP_CODE" == "400" ]]; then
            echo "Create failed (HTTP 400 - likely exists or invalid payload). Searching anyway..."
            echo "Debug response:" && api_body POST "https://api.render.com/v1/services" "$CREATE_JSON" | jq . || true
          else
            echo "Unexpected create response (HTTP $HTTP_CODE). Debug:" && api_body POST "https://api.render.com/v1/services" "$CREATE_JSON" | jq . || true
            exit 1
          fi

          # 2. Always search for ID (paginated, stops on match)
          echo "Searching for service ID..."
          cursor=""
          SERVICE_ID=""
          page=0
          while [[ -z "$SERVICE_ID" || "$SERVICE_ID" == "null" ]]; do
            ((page++))
            search_url="https://api.render.com/v1/services"
            if [[ -n "$cursor" ]]; then
              search_url="$search_url?cursor=$cursor"
            fi
            echo "Scanning page $page..."

            PAGE_BODY=$(api_body GET "$search_url")
            SERVICE_ID=$(echo "$PAGE_BODY" | jq -r --arg n "$SERVICE_NAME" '.[]? | select(.name == $n and .runtime == "static") | .id // empty')

            if [[ -n "$SERVICE_ID" && "$SERVICE_ID" != "null" ]]; then
              echo "‚úÖ Found service ‚Üí ID: $SERVICE_ID"
              break
            fi

            cursor=$(echo "$PAGE_BODY" | jq -r '.next // empty')
            if [[ -z "$cursor" ]]; then
              echo "‚ùå Service '$SERVICE_NAME' not found after $page pages."
              echo "Last page debug:" && echo "$PAGE_BODY" | jq . || true
              exit 1
            fi
            echo "Continuing to next page..."
          done

          # 3. Ensure Vue Router SPA rewrite
          echo "Setting SPA routing rule..."
          UPDATE_JSON=$(jq -n \
            '{
              staticSite: {  # Note: Use web for patch too
                rewriteRules: [{
                  source: "/*",
                  destination: "/index.html",
                  statusCode: 200
                }]
              }
            }')
          PATCH_CODE=$(api PATCH "https://api.render.com/v1/services/$SERVICE_ID" "$UPDATE_JSON")
          if [[ "$PATCH_CODE" != "200" ]]; then
            echo "Warning: Rewrite update returned $PATCH_CODE (may be unchanged)"
          fi

          # 4. Trigger deploy
          echo "Triggering deploy..."
          DEPLOY_BODY=$(api_body POST "https://api.render.com/v1/services/$SERVICE_ID/deploys" "{}")
          DEPLOY_ID=$(echo "$DEPLOY_BODY" | jq -r '.id // empty')
          if [[ -z "$DEPLOY_ID" ]]; then
            echo "‚ùå Failed to trigger deploy. Response:" && echo "$DEPLOY_BODY" | jq . || true
            exit 1
          fi
          echo "üöÄ Deploy started ‚Üí $DEPLOY_ID"
          echo "Dashboard ‚Üí https://dashboard.render.com/srv/$SERVICE_ID"  # Use srv- for web/static

          # 5. Wait for live
          echo "Waiting for deploy (max 10 min)..."
          for i in {1..40}; do
            sleep 15
            STATUS_BODY=$(api_body GET "https://api.render.com/v1/services/$SERVICE_ID/deploys/$DEPLOY_ID")
            STATUS=$(echo "$STATUS_BODY" | jq -r '.status // "unknown"')
            echo "[$i/40] Status: $STATUS"

            if [[ "$STATUS" == "live" ]]; then
              echo "‚úÖ LIVE ‚Üí https://$SERVICE_NAME.onrender.com"
              exit 0
            fi
            if [[ "$STATUS" == "failed" || "$STATUS" == "build_failed" ]]; then
              echo "‚ùå FAILED! Response:" && echo "$STATUS_BODY" | jq . || true
              exit 1
            fi
          done

          echo "‚è∞ Timeout ‚Äî check Render dashboard"
          exit 1