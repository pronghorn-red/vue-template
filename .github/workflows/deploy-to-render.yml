name: Deploy to Render (pronghorn- prefix)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install & Build (validation)
        run: |
          npm ci
          npm run build

      - name: Set Render Service Name (pronghorn- + repo name)
        run: |
          REPO_NAME=$(basename ${{ github.repository }})
          SERVICE_NAME="pronghorn-$REPO_NAME"
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
          echo "RENDER_SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_ENV
          echo "Will deploy to → https://$SERVICE_NAME.onrender.com"

      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          set -e

          SERVICE_NAME="${{ env.RENDER_SERVICE_NAME }}"
          echo "Target service: $SERVICE_NAME"

          api() {
            curl -fsS -w "%{http_code}" -X "$1" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              "$2" \
              ${3:+-d "$3"} || echo "000"
          }

          # 1. Try to create the service
          echo "Attempting to create static site '$SERVICE_NAME'..."
          CREATE_JSON=$(jq -n \
            --arg name "$SERVICE_NAME" \
            --arg repo "https://github.com/${{ github.repository }}.git" \
            '{
              name: $name,
              type: "static_site",
              region: "oregon",
              branch: "main",
              repo: $repo,
              buildCommand: "npm install && npm run build",
              publishPath: "dist",
              autoDeploy: true
            }')

          RESPONSE=$(api POST "https://api.render.com/v1/services" "$CREATE_JSON")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          SERVICE_ID=$(echo "$BODY" | jq -r '.id // empty')

          if [[ "$HTTP_CODE" == "201" && -n "$SERVICE_ID" && "$SERVICE_ID" != "null" ]]; then
            echo "Created new service → $SERVICE_ID"
          else
            echo "Service probably exists (HTTP $HTTP_CODE). Searching by name..."
            
            # 2. Paginated search until we find it
            cursor=""
            while true; do
              url="https://api.render.com/v1/services"
              [[ -n "$cursor" ]] && url="$url?cursor=$cursor"
              
              PAGE=$(api GET "$url")
              PAGE_BODY=$(echo "$PAGE" | sed '$d')
              SERVICE_ID=$(echo "$PAGE_BODY" | jq -r --arg n "$SERVICE_NAME" '.[]? | select(.name == $n) | .id // empty')
              
              if [[ -n "$SERVICE_ID" && "$SERVICE_ID" != "null" ]]; then
                echo "Found existing service → $SERVICE_ID"
                break
              fi
              
              cursor=$(echo "$PAGE_BODY" | jq -r '.next // empty')
              [[ -z "$cursor" ]] && { echo "Service not found after full scan"; exit 1; }
              echo "Next page..."
            done
          fi

          # 3. Ensure Vue Router SPA rewrite
          echo "Setting SPA routing rule..."
          jq -n '{
            staticSite: {
              rewriteRules: [{
                source: "/*",
                destination: "/index.html",
                statusCode: 200
              }]
            }
          }' | api PATCH "https://api.render.com/v1/services/$SERVICE_ID" - > /dev/null

          # 4. Trigger deploy
          echo "Triggering deploy..."
          DEPLOY=$(api POST "https://api.render.com/v1/services/$SERVICE_ID/deploys" "{}")
          DEPLOY_BODY=$(echo "$DEPLOY" | sed '$d')
          DEPLOY_ID=$(echo "$DEPLOY_BODY" | jq -r '.id')

          echo "Deploy started → $DEPLOY_ID"
          echo "Dashboard → https://dashboard.render.com/static/$SERVICE_ID"

          # 5. Wait for live
          for i in {1..40}; do
            sleep 15
            STATUS=$(api GET "https://api.render.com/v1/services/$SERVICE_ID/deploys/$DEPLOY_ID" | sed '$d' | jq -r '.status')
            echo "[$i/40] Status: $STATUS"
            [[ "$STATUS" == "live" ]] && {
              echo "LIVE → https://$SERVICE_NAME.onrender.com"
              exit 0
            }
            [[ "$STATUS" == "failed" || "$STATUS" == "build_failed" ]] && exit 1
          done

          echo "Timeout — check Render dashboard"
          exit 1