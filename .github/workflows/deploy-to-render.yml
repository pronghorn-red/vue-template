name: Deploy to Render (pronghorn- prefix – Blueprint Sync)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For committing render.yaml

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install & Build Vue app
        run: |
          npm ci
          npm run build

      - name: Generate pronghorn- service name
        run: |
          REPO_NAME=$(basename ${{ github.repository }})
          SERVICE_NAME="pronghorn-$REPO_NAME"
          echo "SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_ENV
          echo "Target URL: https://$SERVICE_NAME.onrender.com"

      - name: Create render.yaml Blueprint & Sync
        run: |
          set -e

          # 1. Generate render.yaml with dynamic name + Vue Router rewrite
          cat > render.yaml << EOF
          services:
            - type: web
              name: $SERVICE_NAME
              runtime: static
              region: oregon
              branch: main
              repo: https://github.com/${{ github.repository }}.git

              buildCommand: npm install && npm run build
              staticPublishPath: dist

              # Vue Router history mode → serve index.html for all paths
              routes:
                - type: rewrite
                  source: /*
                  destination: /index.html
                  statusCode: 200

              autoDeployTrigger: commit
          EOF

          # 2. Commit & push (triggers Render Blueprint sync automatically)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          git add render.yaml
          if git diff --staged --quiet; then
            echo "No changes to render.yaml – skipping commit"
          else
            git commit -m "chore: sync render.yaml blueprint – $(date +%Y-%m-%d)"
            git push origin main
            echo "✅ Pushed render.yaml – Render will sync & deploy in ~1-2 min"
          fi

          echo "All set! First run: Render creates site. Subsequent: Overwrites dist/."
          echo "Monitor at: https://dashboard.render.com"
          echo "Live URL: https://$SERVICE_NAME.onrender.com"