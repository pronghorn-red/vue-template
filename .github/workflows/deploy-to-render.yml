name: Deploy to Render (Fully Automated – pronghorn- prefix)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # Needed to commit render.yaml temporarily

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install & Build Vue app
        run: |
          npm ci
          npm run build

      - name: Generate pronghorn- service name
        run: |
          REPO_NAME=$(basename ${{ github.repository }})
          SERVICE_NAME="pronghorn-$REPO_NAME"
          echo "SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_ENV
          echo "Target URL: https://$SERVICE_NAME.onrender.com"

      - name: Create/Update render.yaml Blueprint + Deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          set -e

          # 1. Build the render.yaml content with correct name + Vue SPA rewrite
          cat > render.yaml << 'EOF'
          services:
            - type: web
              name: ${{ env.SERVICE_NAME }}
              runtime: static
              region: oregon
              branch: main
              repo: https://github.com/${{ github.repository }}.git

              buildCommand: npm install && npm run build
              staticPublishPath: dist

              # Vue Router history mode → always serve index.html
              routes:
                - type: rewrite
                  source: /*
                  destination: /index.html
                  statusCode: 200

              autoDeployTrigger: commit
          EOF

          # 2. Commit render.yaml (triggers Blueprint sync)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          git add render.yaml
          git commit -m "chore: update render.yaml – auto-deploy $(date)" || echo "No changes to commit"
          git push origin main

          # 3. Trigger immediate deploy via Render Blueprint API (fastest feedback)
          echo "Triggering Render Blueprint deploy..."
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{}' \
            https://api.render.com/deploy)

          DEPLOY_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          if [ -n "$DEPLOY_ID" ] && [ "$DEPLOY_ID" != "null" ]; then
            echo "Deploy triggered → $DEPLOY_ID"
            echo "Dashboard: https://dashboard.render.com"
          else
            echo "Deploy API response:"
            echo "$RESPONSE" | jq .
          fi

          echo "All done! Your site will be live at https://${{ env.SERVICE_NAME }}.onrender.com in ~1–2 min"