name: Deploy to Render

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install & Build
        run: |
          npm ci
          npm run build

      - name: Extract Repository Name
        run: |
          REPO_NAME=$(basename ${{ github.repository }})
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV

      - name: Deploy to Render.com
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          set -e  # Exit on any error

          # Curl wrapper for API calls
          api() {
            local method="${1:-GET}"
            local url="$2"
            local extra_headers="$3"
            local data="$4"
            curl -fsS -X "$method" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              $extra_headers \
              $url \
              $data
          }

          SERVICE_NAME="${{ env.REPO_NAME }}"
          echo "Target Render service name: $SERVICE_NAME"

          # === 1. List ALL services and find by name ===
          echo "Fetching all services to check for existing..."
          SERVICES=$(api "https://api.render.com/v1/services?limit=100")
          EXISTING_ID=$(echo "$SERVICES" | jq -r --arg name "$SERVICE_NAME" '.[] | select(.name == $name) | .id // empty')

          if [ -z "$EXISTING_ID" ] || [ "$EXISTING_ID" = "null" ]; then
            echo "No existing service found. Creating new static site..."

            # Build create payload with jq (no heredoc!)
            CREATE_JSON=$(jq -n \
              --arg name "$SERVICE_NAME" \
              --arg repo "https://github.com/${{ github.repository }}.git" \
              '{
                name: $name,
                type: "static_site",
                region: "oregon",
                branch: "main",
                repo: $repo,
                buildCommand: "npm install && npm run build",
                publishPath: "dist",
                autoDeploy: true
              }')

            RESPONSE=$(api POST "https://api.render.com/v1/services" "" "-d $CREATE_JSON")
            SERVICE_ID=$(echo "$RESPONSE" | jq -r '.id')

            if [ -z "$SERVICE_ID" ] || [ "$SERVICE_ID" = "null" ]; then
              echo "Failed to create service. Full response:"
              echo "$RESPONSE" | jq .
              exit 1
            fi

            echo "Created new static site → ID: $SERVICE_ID"
          else
            SERVICE_ID="$EXISTING_ID"
            echo "Found existing service → ID: $SERVICE_ID"
          fi

          # === 2. Add SPA rewrite rule for Vue Router ===
          echo "Configuring SPA routing (/* → /index.html)..."
          # Build update payload with jq
          UPDATE_JSON=$(jq -n \
            '{
              staticSite: {
                rewriteRules: [
                  {
                    source: "/*",
                    destination: "/index.html",
                    statusCode: 200
                  }
                ]
              }
            }')

          api PATCH "https://api.render.com/v1/services/$SERVICE_ID" "" "-d $UPDATE_JSON" > /dev/null || echo "Rewrite update completed (or unchanged)."

          # === 3. Trigger deploy ===
          echo "Triggering deploy..."
          DEPLOY=$(api POST "https://api.render.com/v1/services/$SERVICE_ID/deploys" "" "-d {}")
          DEPLOY_ID=$(echo "$DEPLOY" | jq -r '.id // empty')

          if [ -z "$DEPLOY_ID" ]; then
            echo "Failed to trigger deploy. Response: $DEPLOY"
            exit 1
          fi

          echo "Deploy started → ID: $DEPLOY_ID"
          echo "Dashboard: https://dashboard.render.com/static/$SERVICE_ID"

          # === 4. Poll for deploy status ===
          echo "Waiting for deploy to complete (max ~10 min)..."
          for i in {1..40}; do
            sleep 15
            STATUS_RESPONSE=$(api "https://api.render.com/v1/services/$SERVICE_ID/deploys/$DEPLOY_ID")
            STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.status // "unknown"')
            echo "Deploy $i/40: $STATUS"

            case "$STATUS" in
              "live")
                echo "✅ Deploy successful!"
                echo "Live URL: https://$SERVICE_NAME.onrender.com"
                exit 0
                ;;
              "failed"|"build_failed"|"canceled")
                echo "❌ Deploy failed! Check logs in Render dashboard."
                echo "Details: $(echo "$STATUS_RESPONSE" | jq .)"
                exit 1
                ;;
              "pending"|"in_progress")
                # Continue waiting
                ;;
              *)
                echo "Unknown status: $STATUS - continuing..."
                ;;
            esac
          done

          echo "⏰ Timeout: Deploy not finished in 10 min. Check dashboard."
          exit 1