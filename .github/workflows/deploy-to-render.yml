name: Deploy to Render

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install & Build
        run: |
          npm ci
          npm run build

      - name: Extract Repository Name
        run: |
          REPO_NAME=$(basename ${{ github.repository }})
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV

      - name: Deploy to Render.com
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          set -e  # Fail fast on any error

          # Simple curl wrapper
          api() {
            curl -fsS \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Accept: application/json" \
              "$@"
          }

          SERVICE_NAME="${{ env.REPO_NAME }}"
          echo "Target Render service name: $SERVICE_NAME"

          # === 1. Find existing service by name ===
          echo "Checking if service already exists..."
          EXISTING_ID=$(api "https://api.render.com/v1/services?name=$SERVICE_NAME" -H "Content-Type: application/json" | jq -r '.[0].id // empty')

          if [ -z "$EXISTING_ID" ]; then
            echo "No existing service found. Creating new static site..."

            CREATE_JSON=$(cat <<EOF
            {
              "name": "$SERVICE_NAME",
              "type": "static_site",
              "region": "oregon",
              "branch": "main",
              "repo": "https://github.com/${{ github.repository }}.git",
              "buildCommand": "npm install && npm run build",
              "publishPath": "dist",
              "autoDeploy": true
            }
            EOF
            )

            RESPONSE=$(api -X POST -H "Content-Type: application/json" -d "$CREATE_JSON" https://api.render.com/v1/services)
            SERVICE_ID=$(echo "$RESPONSE" | jq -r '.id')

            if [ -z "$SERVICE_ID" ] || [ "$SERVICE_ID" = "null" ]; then
              echo "Failed to create service:"
              echo "$RESPONSE" | jq .
              exit 1
            fi

            echo "Created new static site → $SERVICE_ID"
          else
            SERVICE_ID="$EXISTING_ID"
            echo "Found existing service → $SERVICE_ID"
          fi

          # === 2. Ensure SPA routing (Vue Router history mode) ===
          echo "Applying SPA rewrite rule..."
          UPDATE_JSON=$(cat <<EOF
          {
            "staticSite": {
              "rewriteRules": [
                {
                  "source": "/*",
                  "destination": "/index.html",
                  "statusCode": 200
                }
              ]
            }
          }
          EOF
          )

          api -X PATCH -H "Content-Type: application/json" -d "$UPDATE_JSON" "https://api.render.com/v1/services/$SERVICE_ID" > /dev/null

          # === 3. Trigger deploy ===
          echo "Triggering new deploy..."
          DEPLOY=$(api -X POST -H "Content-Type: application/json" -d '{}' "https://api.render.com/v1/services/$SERVICE_ID/deploys")
          DEPLOY_ID=$(echo "$DEPLOY" | jq -r '.id')

          echo "Deploy started: $DEPLOY_ID"
          echo "Dashboard → https://dashboard.render.com/static/$SERVICE_ID"

          # === 4. Wait for deploy to go live ===
          echo "Waiting for deploy to complete (max 10 minutes)..."
          for i in {1..40}; do
            sleep 15
            STATUS=$(api "https://api.render.com/v1/services/$SERVICE_ID/deploys/$DEPLOY_ID" | jq -r '.status')
            echo "Deploy status: $STATUS"

            case "$STATUS" in
              live)
                echo "Deploy successful!"
                echo "Your site is live at → https://$SERVICE_NAME.onrender.com"
                exit 0
                ;;
              build_failed|failed|canceled)
                echo "Deploy failed!"
                exit 1
                ;;
            esac
          done

          echo "Timeout: Deploy did not complete in time"
          exit 1