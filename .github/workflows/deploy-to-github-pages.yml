name: Deploy to Render (pronghorn- prefix – Upload Static Files)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install & Build Vue app
        run: |
          npm ci
          npm run build

      - name: Generate pronghorn- service name
        run: |
          REPO_NAME=$(basename ${{ github.repository }})
          SERVICE_NAME="pronghorn-$REPO_NAME"
          echo "SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_ENV
          echo "Target URL: https://$SERVICE_NAME.onrender.com"

      - name: Create/Find Service & Upload/Deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          set -e

          SERVICE_NAME="${{ env.SERVICE_NAME }}"
          echo "Target service: $SERVICE_NAME"

          # API helpers
          api_body() {
            local method="$1" url="$2" data="$3"
            curl -fsS -X "$method" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              "$url" \
              ${data:+-d "$data"}
          }

          http_code() {
            local method="$1" url="$2" data="$3"
            curl -fsS -w "%{http_code}" -o /dev/null -X "$method" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Content-Type: application/json" \
              "$url" \
              ${data:+-d "$data"}
          }

          # 1. Try create static site (fixed payload: publishPath, no startCommand)
          echo "Attempting to create static site..."
          CREATE_JSON=$(jq -n \
            --arg name "$SERVICE_NAME" \
            --arg repo "https://github.com/${{ github.repository }}.git" \
            '{
              name: $name,
              type: "web",
              runtime: "static",
              region: "oregon",
              branch: "main",
              repo: $repo,
              buildCommand: "npm install && npm run build",
              publishPath: "dist",
              autoDeploy: true
            }')

          CREATE_CODE=$(http_code POST "https://api.render.com/v1/services" "$CREATE_JSON")
          if [[ "$CREATE_CODE" == "201" ]]; then
            CREATE_BODY=$(api_body POST "https://api.render.com/v1/services" "$CREATE_JSON")
            SERVICE_ID=$(echo "$CREATE_BODY" | jq -r '.id // empty')
            echo "✅ Created new static site → ID: $SERVICE_ID"
          else
            echo "Create returned $CREATE_CODE (likely exists). Debug:"
            api_body POST "https://api.render.com/v1/services" "$CREATE_JSON" | jq . || echo "Empty"
            echo "Proceeding to search..."
          fi

          # 2. Search for service ID
          echo "Searching for '$SERVICE_NAME'..."
          cursor=""
          SERVICE_ID=""
          page=0
          while [[ -z "$SERVICE_ID" || "$SERVICE_ID" == "null" ]]; do
            ((page++))
            search_url="https://api.render.com/v1/services"
            [[ -n "$cursor" ]] && search_url="$search_url?cursor=$cursor"
            echo "Page $page..."

            PAGE_BODY=$(api_body GET "$search_url")
            PAGE_CODE=$(http_code GET "$search_url")

            if [[ "$PAGE_CODE" != "200" ]]; then
              echo "❌ Search failed (HTTP $PAGE_CODE). Check API key."
              exit 1
            fi

            SERVICE_ID=$(echo "$PAGE_BODY" | jq -r --arg n "$SERVICE_NAME" '.[]? | select(.name == $n) | .id // empty')

            if [[ -n "$SERVICE_ID" && "$SERVICE_ID" != "null" ]]; then
              echo "✅ Found service → ID: $SERVICE_ID"
              break
            fi

            cursor=$(echo "$PAGE_BODY" | jq -r '.next // empty')
            [[ -z "$cursor" ]] && {
              echo "❌ Service not found. Create manually, then re-push."
              exit 1
            }
          done

          # 3. Zip built dist/
          echo "Zipping dist/ for upload..."
          tar -czf dist.tar.gz -C dist .

          # 4. Upload static files (instant overwrite – preferred for speed)
          echo "Uploading built files to overwrite site..."
          UPLOAD_CODE=$(curl -fsS -w "%{http_code}" -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -F "archive=@dist.tar.gz" \
            "https://api.render.com/v1/services/$SERVICE_ID/static-site-archive" \
            -o /dev/null)

          if [[ "$UPLOAD_CODE" == "200" ]]; then
            echo "✅ Files uploaded – site updated instantly!"
          else
            echo "Upload failed (HTTP $UPLOAD_CODE) – falling back to Git deploy..."
            # Fallback: Trigger Git build/deploy
            DEPLOY_BODY=$(api_body POST "https://api.render.com/v1/services/$SERVICE_ID/deploys" "{}")
            DEPLOY_CODE=$(http_code POST "https://api.render.com/v1/services/$SERVICE_ID/deploys" "{}")
            if [[ "$DEPLOY_CODE" != "201" ]]; then
              echo "❌ Fallback deploy failed (HTTP $DEPLOY_CODE)."
              exit 1
            fi
            DEPLOY_ID=$(echo "$DEPLOY_BODY" | jq -r '.id // empty')
            echo "Fallback deploy started → $DEPLOY_ID"
          fi

          # 5. Apply Vue Router rewrite
          echo "Applying SPA rewrites..."
          UPDATE_JSON=$(jq -n \
            '{
              staticSite: {
                rewriteRules: [{
                  source: "/*",
                  destination: "/index.html",
                  statusCode: 200
                }]
              }
            }')
          UPDATE_CODE=$(http_code PATCH "https://api.render.com/v1/services/$SERVICE_ID" "$UPDATE_JSON")
          [[ "$UPDATE_CODE" == "200" ]] && echo "✅ Rewrites applied" || echo "Warning: $UPDATE_CODE"

          # 6. Wait for live (poll last deploy)
          echo "Waiting for live (max 5 min)..."
          LAST_DEPLOY_BODY=$(api_body GET "https://api.render.com/v1/services/$SERVICE_ID/deploys?limit=1")
          DEPLOY_ID=$(echo "$LAST_DEPLOY_BODY" | jq -r '.[0].id // empty')

          for i in {1..20}; do
            sleep 15
            STATUS_BODY=$(api_body GET "https://api.render.com/v1/services/$SERVICE_ID/deploys/$DEPLOY_ID")
            STATUS=$(echo "$STATUS_BODY" | jq -r '.status // "unknown"')
            echo "[$i/20] Status: $STATUS"

            if [[ "$STATUS" == "live" ]]; then
              echo "✅ SUCCESS! Live at https://$SERVICE_NAME.onrender.com"
              exit 0
            fi
            if [[ "$STATUS" == "failed" || "$STATUS" == "build_failed" ]]; then
              echo "❌ FAILED! Details:"
              echo "$STATUS_BODY" | jq .
              exit 1
            fi
          done

          echo "⏰ Timeout. Check dashboard."
          exit 1